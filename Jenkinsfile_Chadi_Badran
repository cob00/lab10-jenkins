pipeline {
  agent any
  environment {
    VIRTUAL_ENV = 'venv'
    PY = 'py -3'
    PYTHONPATH = "${WORKSPACE}"
  }

  stages {

    stage('Setup') {
      steps {
        bat """
          if not exist %VIRTUAL_ENV% %PY% -m venv %VIRTUAL_ENV%
          call %VIRTUAL_ENV%\\Scripts\\activate
          %PY% -m pip install --upgrade pip
          %PY% -m pip install -r requirements.txt
        """
      }
    }

    stage('Lint') {
      steps {
        bat """
          call %VIRTUAL_ENV%\\Scripts\\activate
          flake8 app.py
        """
      }
    }

    stage('Test') {
      steps {
        bat """
          call %VIRTUAL_ENV%\\Scripts\\activate
          pytest -q
        """
      }
    }

    stage('Coverage') {
    steps {
        bat """
        call %VIRTUAL_ENV%\\Scripts\\activate
        coverage run -m pytest
        coverage xml -o coverage.xml
        """
        archiveArtifacts artifacts: 'coverage.xml', fingerprint: true
    }
    }

    stage('Security Scan') {
      steps {
        bat """
          call %VIRTUAL_ENV%\\Scripts\\activate
          bandit -r . -ll -iii
        """
      }
    }

    stage('Deploy') {
      steps {
        bat "echo Deploying application..."
      }
    }

  }

  post {
    always {
      cleanWs()
    }
  }
}
